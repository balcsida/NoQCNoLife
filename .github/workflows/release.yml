name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build and Release DMG
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        
      - name: Build Release
        run: |
          xcodebuild clean build \
            -project NoQCNoLife.xcodeproj \
            -scheme NoQCNoLife \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="io.github.balcsida.NoQCNoLife"
            
      - name: Install create-dmg
        run: |
          npm install -g create-dmg
          
      - name: Extract app icon
        run: |
          # Extract the largest icon from the app for use as volume icon
          iconutil -c iconset "build/Build/Products/Release/NoQCNoLife.app/Contents/Resources/AppIcon.icns"
          cp AppIcon.iconset/icon_512x512@2x.png volume-icon.png || \
          cp AppIcon.iconset/icon_512x512.png volume-icon.png || \
          echo "Warning: Could not extract volume icon"
          
      - name: Create DMG
        run: |
          # Create professional DMG using create-dmg
          npx create-dmg \
            --volname "NoQCNoLife ${{ steps.get_version.outputs.VERSION }}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "NoQCNoLife.app" 150 185 \
            --hide-extension "NoQCNoLife.app" \
            --app-drop-link 450 185 \
            --no-internet-enable \
            "NoQCNoLife-${{ steps.get_version.outputs.VERSION }}.dmg" \
            "build/Build/Products/Release/NoQCNoLife.app" || \
          # Fallback to basic DMG if create-dmg fails
          (echo "create-dmg failed, falling back to hdiutil..." && \
           mkdir -p dmg_temp && \
           cp -R "build/Build/Products/Release/NoQCNoLife.app" dmg_temp/ && \
           ln -s /Applications dmg_temp/Applications && \
           hdiutil create -volname "NoQCNoLife ${{ steps.get_version.outputs.VERSION }}" \
             -srcfolder dmg_temp \
             -ov -format UDZO \
             "NoQCNoLife-${{ steps.get_version.outputs.VERSION }}.dmg")
            
      - name: Calculate checksums
        id: checksums
        run: |
          shasum -a 256 "NoQCNoLife-${{ steps.get_version.outputs.VERSION }}.dmg" > checksums.txt
          echo "SHA256=$(shasum -a 256 NoQCNoLife-${{ steps.get_version.outputs.VERSION }}.dmg | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## NoQCNoLife ${{ github.ref_name }}
            
            Control your Bose QuietComfort headphones from macOS.
            
            ### Installation
            
            #### Option 1: Download DMG
            Download the DMG file below and drag NoQCNoLife.app to your Applications folder.
            
            #### Option 2: Homebrew
            ```bash
            brew tap balcsida/tap
            brew install --cask noqcnolife
            ```
            
            ### Checksums
            SHA256: `${{ steps.checksums.outputs.SHA256 }}`
            
            ### Supported Devices
            - Bose QuietComfort 35
            - Bose QuietComfort 35 Series II
            - Bose SoundWear Companion
            
            ### Requirements
            - macOS 10.13 (High Sierra) or later
            - Bluetooth enabled
            
          files: |
            NoQCNoLife-${{ steps.get_version.outputs.VERSION }}.dmg
            checksums.txt
          
      - name: Update Homebrew Tap
        continue-on-error: true
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Try to update the Homebrew tap
          # This requires a Fine-grained Personal Access Token
          # Add it as HOMEBREW_TAP_TOKEN secret in repository settings
          
          if [ -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]; then
            echo "::warning title=Homebrew Tap Update::HOMEBREW_TAP_TOKEN secret not set. Manual update required."
            echo "To enable automatic updates:"
            echo "1. Create a Fine-grained Personal Access Token:"
            echo "   - Go to GitHub Settings → Developer settings → Fine-grained tokens"
            echo "   - Select only 'balcsida/homebrew-tap' repository"
            echo "   - Grant 'Contents: Read and Write' permission"
            echo "2. Add it as HOMEBREW_TAP_TOKEN secret in repository settings"
            echo ""
            echo "Manual update command:"
            echo "./scripts/update-homebrew-tap.sh ${{ steps.get_version.outputs.VERSION }} ${{ steps.checksums.outputs.SHA256 }}"
            exit 0
          fi
          
          # Clone the tap repository using token
          git clone https://${HOMEBREW_TAP_TOKEN}@github.com/balcsida/homebrew-tap.git tap-repo
          cd tap-repo
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update the formula
          cat > Casks/noqcnolife.rb << EOF
          cask "noqcnolife" do
            version "${{ steps.get_version.outputs.VERSION }}"
            sha256 "${{ steps.checksums.outputs.SHA256 }}"
          
            url "https://github.com/balcsida/NoQCNoLife/releases/download/v#{version}/NoQCNoLife-#{version}.dmg"
            name "No QC, No Life"
            desc "Control Bose QuietComfort headphones from macOS"
            homepage "https://github.com/balcsida/NoQCNoLife"
          
            auto_updates false
            depends_on macos: ">= :high_sierra"
          
            app "NoQCNoLife.app"
          
            uninstall quit: "io.github.balcsida.NoQCNoLife"
          
            zap trash: [
              "~/Library/Preferences/io.github.balcsida.NoQCNoLife.plist",
              "~/Library/Application Support/NoQCNoLife",
            ]
          end
          EOF
          
          # Commit and push
          git add Casks/noqcnolife.rb
          git commit -m "Update NoQCNoLife to v${{ steps.get_version.outputs.VERSION }}" || echo "No changes to commit"
          git push || echo "Push failed - manual update required"